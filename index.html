<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostMessage Interceptor - SeekOut Bug Bounty</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #bdc3c7;
            font-size: 14px;
        }
        
        .controls {
            padding: 20px 30px;
            background: #ecf0f1;
            border-bottom: 2px solid #bdc3c7;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-warning {
            color: #e74c3c;
        }
        
        .filter-bar {
            padding: 15px 30px;
            background: #fff;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        select {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .log-container {
            padding: 20px 30px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .log-entry {
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }
        
        .log-entry:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }
        
        .log-entry.received {
            border-left-color: #2ecc71;
        }
        
        .log-entry.sent {
            border-left-color: #3498db;
        }
        
        .log-entry.suspicious {
            border-left-color: #e74c3c;
            background: #ffe6e6;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            cursor: pointer;
        }
        
        .log-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log-type.received {
            background: #2ecc71;
            color: white;
        }
        
        .log-type.sent {
            background: #3498db;
            color: white;
        }
        
        .log-timestamp {
            color: #7f8c8d;
            font-size: 12px;
            font-family: monospace;
        }
        
        .log-body {
            padding: 15px;
            display: none;
        }
        
        .log-body.expanded {
            display: block;
        }
        
        .log-field {
            margin-bottom: 10px;
        }
        
        .log-field-label {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .log-field-value {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            border: 1px solid #ecf0f1;
        }
        
        .warning-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 30px;
        }
        
        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #856404;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        code {
            background: #2c3e50;
            color: #2ecc71;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç PostMessage Interceptor</h1>
            <div class="subtitle">Real-time message monitoring for bug bounty testing</div>
        </header>
        
        <div class="instructions">
            <h3>üìã How to Use:</h3>
            <ol>
                <li>Open <code>https://app-ppe.seekout.io</code> in another tab</li>
                <li>Keep this page open in a separate tab/window</li>
                <li>Interact with SeekOut (login, search, use features)</li>
                <li>Watch messages appear here in real-time</li>
                <li>Click "Export JSON" to save findings</li>
            </ol>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Messages</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Received</div>
                <div class="stat-value" id="stat-received" style="color: #2ecc71;">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Sent</div>
                <div class="stat-value" id="stat-sent" style="color: #3498db;">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Suspicious</div>
                <div class="stat-value stat-warning" id="stat-suspicious">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unique Origins</div>
                <div class="stat-value" id="stat-origins">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Wildcards (*)</div>
                <div class="stat-value stat-warning" id="stat-wildcards">0</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn-primary" onclick="interceptor.startListening()">‚ñ∂Ô∏è Start Listening</button>
            <button class="btn-danger" onclick="interceptor.stopListening()">‚èπÔ∏è Stop</button>
            <button class="btn-warning" onclick="interceptor.clearLogs()">üóëÔ∏è Clear Logs</button>
            <button class="btn-success" onclick="interceptor.exportJSON()">üíæ Export JSON</button>
            <button class="btn-primary" onclick="interceptor.exportCSV()">üìä Export CSV</button>
            <button class="btn-success" onclick="interceptor.testSend()">üß™ Test Send</button>
        </div>
        
        <div class="filter-bar">
            <input type="text" id="search-input" placeholder="üîç Search messages (origin, data, event...)" onkeyup="interceptor.filterLogs()">
            <select id="filter-type" onchange="interceptor.filterLogs()">
                <option value="all">All Messages</option>
                <option value="received">Received Only</option>
                <option value="sent">Sent Only</option>
                <option value="suspicious">Suspicious Only</option>
                <option value="wildcard">Wildcard Only</option>
            </select>
        </div>
        
        <div class="log-container" id="log-container">
            <div class="empty-state">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                    <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                </svg>
                <h3>No messages captured yet</h3>
                <p>Start listening to capture postMessage events</p>
            </div>
        </div>
    </div>

    <script>
        const interceptor = {
            logs: [],
            listening: false,
            messageListener: null,
            origins: new Set(),
            
            init() {
                console.log('üöÄ PostMessage Interceptor initialized');
                console.log('üìç This page origin:', window.location.origin);
                this.startListening();
            },
            
            startListening() {
                if (this.listening) return;
                
                this.listening = true;
                this.messageListener = (event) => this.handleMessage(event);
                window.addEventListener('message', this.messageListener, true);
                
                console.log('‚úÖ Started listening for postMessage events');
                this.showNotification('Started listening', 'success');
            },
            
            stopListening() {
                if (!this.listening) return;
                
                this.listening = false;
                if (this.messageListener) {
                    window.removeEventListener('message', this.messageListener, true);
                }
                
                console.log('‚èπÔ∏è Stopped listening');
                this.showNotification('Stopped listening', 'warning');
            },
            
            handleMessage(event) {
                const log = {
                    id: Date.now() + Math.random(),
                    timestamp: Date.now(),
                    time: new Date().toISOString(),
                    type: 'received',
                    origin: event.origin,
                    data: this.cloneData(event.data),
                    isTrusted: event.isTrusted,
                    sourceType: this.getSourceType(event.source),
                    suspicious: this.isSuspicious(event)
                };
                
                this.logs.push(log);
                this.origins.add(event.origin);
                
                console.log('üì• Message received:', log);
                
                if (log.suspicious) {
                    console.warn('‚ö†Ô∏è SUSPICIOUS MESSAGE:', log);
                }
                
                this.updateUI();
            },
            
            cloneData(data) {
                try {
                    return JSON.parse(JSON.stringify(data));
                } catch (e) {
                    return String(data);
                }
            },
            
            getSourceType(source) {
                if (source === window) return 'self';
                if (source === window.parent) return 'parent';
                if (source === window.top) return 'top';
                return 'iframe';
            },
            
            isSuspicious(event) {
                const suspicious = [];
                
                // Check for SeekOut origin
                if (event.origin.includes('seekout')) {
                    suspicious.push('seekout-origin');
                }
                
                // Check for tokens
                if (typeof event.data === 'object' && event.data) {
                    if (event.data.token || event.data.sToken) {
                        suspicious.push('contains-token');
                    }
                    if (event.data.widgetId) {
                        suspicious.push('has-widgetid');
                    }
                    if (event.data.password || event.data.secret || event.data.key) {
                        suspicious.push('sensitive-data');
                    }
                }
                
                // Check for specific event types from the code
                if (typeof event.data === 'object' && event.data && event.data.event) {
                    const suspiciousEvents = ['complete', 'fail', 'tokenExpired', 'init'];
                    if (suspiciousEvents.includes(event.data.event)) {
                        suspicious.push(`event-${event.data.event}`);
                    }
                }
                
                return suspicious.length > 0 ? suspicious : false;
            },
            
            updateUI() {
                this.updateStats();
                this.renderLogs();
            },
            
            updateStats() {
                const stats = {
                    total: this.logs.length,
                    received: this.logs.filter(l => l.type === 'received').length,
                    sent: this.logs.filter(l => l.type === 'sent').length,
                    suspicious: this.logs.filter(l => l.suspicious).length,
                    origins: this.origins.size,
                    wildcards: this.logs.filter(l => l.targetOrigin === '*').length
                };
                
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-received').textContent = stats.received;
                document.getElementById('stat-sent').textContent = stats.sent;
                document.getElementById('stat-suspicious').textContent = stats.suspicious;
                document.getElementById('stat-origins').textContent = stats.origins;
                document.getElementById('stat-wildcards').textContent = stats.wildcards;
            },
            
            renderLogs() {
                const container = document.getElementById('log-container');
                const filteredLogs = this.getFilteredLogs();
                
                if (filteredLogs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No messages match the filter</h3>
                            <p>Try adjusting your search or filter settings</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = filteredLogs.map(log => this.renderLogEntry(log)).join('');
            },
            
            renderLogEntry(log) {
                const dataStr = typeof log.data === 'object' 
                    ? JSON.stringify(log.data, null, 2) 
                    : String(log.data);
                
                const suspiciousBadge = log.suspicious 
                    ? `<span class="warning-badge">‚ö†Ô∏è ${log.suspicious.join(', ')}</span>` 
                    : '';
                
                return `
                    <div class="log-entry ${log.type} ${log.suspicious ? 'suspicious' : ''}" data-id="${log.id}">
                        <div class="log-header" onclick="interceptor.toggleLog('${log.id}')">
                            <div>
                                <span class="log-type ${log.type}">${log.type}</span>
                                ${suspiciousBadge}
                            </div>
                            <span class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="log-body" id="log-body-${log.id}">
                            <div class="log-field">
                                <div class="log-field-label">Origin</div>
                                <div class="log-field-value">${log.origin || 'N/A'}</div>
                            </div>
                            <div class="log-field">
                                <div class="log-field-label">Source Type</div>
                                <div class="log-field-value">${log.sourceType}</div>
                            </div>
                            <div class="log-field">
                                <div class="log-field-label">Trusted</div>
                                <div class="log-field-value">${log.isTrusted ? '‚úÖ Yes' : '‚ùå No'}</div>
                            </div>
                            <div class="log-field">
                                <div class="log-field-label">Data</div>
                                <div class="log-field-value"><pre>${this.escapeHtml(dataStr)}</pre></div>
                            </div>
                            ${log.targetOrigin ? `
                            <div class="log-field">
                                <div class="log-field-label">Target Origin</div>
                                <div class="log-field-value">${log.targetOrigin}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },
            
            toggleLog(id) {
                const body = document.getElementById(`log-body-${id}`);
                body.classList.toggle('expanded');
            },
            
            getFilteredLogs() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const filterType = document.getElementById('filter-type').value;
                
                return this.logs.filter(log => {
                    // Type filter
                    if (filterType === 'received' && log.type !== 'received') return false;
                    if (filterType === 'sent' && log.type !== 'sent') return false;
                    if (filterType === 'suspicious' && !log.suspicious) return false;
                    if (filterType === 'wildcard' && log.targetOrigin !== '*') return false;
                    
                    // Search filter
                    if (searchTerm) {
                        const searchableText = JSON.stringify(log).toLowerCase();
                        if (!searchableText.includes(searchTerm)) return false;
                    }
                    
                    return true;
                }).reverse(); // Show newest first
            },
            
            filterLogs() {
                this.renderLogs();
            },
            
            clearLogs() {
                if (confirm('Clear all logs?')) {
                    this.logs = [];
                    this.origins = new Set();
                    this.updateUI();
                    this.showNotification('Logs cleared', 'success');
                }
            },
            
            exportJSON() {
                const data = {
                    exportTime: new Date().toISOString(),
                    totalMessages: this.logs.length,
                    logs: this.logs,
                    origins: Array.from(this.origins)
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                this.downloadFile(blob, `postmessage-logs-${Date.now()}.json`);
                this.showNotification('Exported JSON', 'success');
            },
            
            exportCSV() {
                const headers = ['Timestamp', 'Type', 'Origin', 'Source Type', 'Suspicious', 'Data'];
                const rows = this.logs.map(log => [
                    new Date(log.timestamp).toISOString(),
                    log.type,
                    log.origin || '',
                    log.sourceType,
                    log.suspicious ? log.suspicious.join(';') : 'No',
                    typeof log.data === 'object' ? JSON.stringify(log.data) : log.data
                ]);
                
                const csv = [headers, ...rows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                this.downloadFile(blob, `postmessage-logs-${Date.now()}.csv`);
                this.showNotification('Exported CSV', 'success');
            },
            
            downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            testSend() {
                // Send a test message to see if we can capture our own sends
                window.postMessage({ test: true, timestamp: Date.now() }, '*');
                this.showNotification('Test message sent', 'success');
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            showNotification(message, type) {
                // Simple notification - you could make this fancier
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        };
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            interceptor.init();
        });
        
        // Make interceptor available globally for debugging
        window.interceptor = interceptor;
    </script>
</body>
</html>
